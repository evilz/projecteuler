@inherits LayoutComponentBase
@inject NavigationManager Navigation
@using System.Reflection
@using Projecteuler.Components.Problems
@namespace Projecteuler.Components

<Rows>
    <Figlet Content="Project Euler"  Color="Color.Blue" />
    <Newline />

    <Panel Title="Problem Selector" Border="BoxBorder.Rounded" Expand="true">
        <Rows>
            <Select  Options="@_problemOptions.Select(num => _problemTitles[num]).ToArray()"
                     Value="@(_selectedRef != null && _problemTitles.ContainsKey(_selectedRef) ? _problemTitles[_selectedRef] : null)"
                     ValueChanged="@(value => OnSelectionChanged(_problemOptions.First(num => _problemTitles[num] == value)))"
                     Placeholder=" Choose a problem "></Select>
        </Rows>
    </Panel>
    
    <Newline />
    @Body
</Rows>

@code {
    private Dictionary<string, string> _problemTitles = new();
    private string[] _problemOptions = Array.Empty<string>();
    private string? _selectedRef;

    protected override void OnInitialized()
    {
        var problems = new List<(int Id, string Title)>();
        
        var problemTypes = Assembly.GetExecutingAssembly().GetTypes()
            .Where(t => t.IsSubclassOf(typeof(ProblemBase)) && !t.IsAbstract);

        foreach (var type in problemTypes)
        {
            try 
            {
                var instance = Activator.CreateInstance(type);
                
                var refProp = type.GetProperty("Ref", BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public);
                var titleProp = type.GetProperty("ProblemTitle", BindingFlags.Instance | BindingFlags.NonPublic | BindingFlags.Public);

                if (refProp == null || titleProp == null) continue;
                var id = (int)refProp.GetValue(instance)!;
                var title = (string)titleProp.GetValue(instance)!;
                problems.Add((id, title));
            }
            catch
            {
                // Ignore types that cannot be instantiated
            }
        }

        var sortedProblems = problems.OrderBy(p => p.Id).ToList();

        _problemTitles = sortedProblems.ToDictionary(
            p => p.Id.ToString(), 
            p => $"{p.Id}: {p.Title}"
        );

        _problemOptions = sortedProblems.Select(p => p.Id.ToString()).ToArray();
    }

    private void OnSelectionChanged(string value)
    {
         _selectedRef = value;
         Navigation.NavigateTo($"/problem/{value}");
    }
}
